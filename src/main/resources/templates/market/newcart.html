<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>farmPlus</title>
    <link rel="stylesheet" th:href="@{/newcss/mainStyle.css}">
    <script>
        window.onload = function(){
        //// 페이지 로드시 장바구니 상품 합계 금액 표시 ////
            orderPriceSub();

        //// 수량 조절시 실시간 가격 조정 ////
            const plusBtns = document.getElementsByClassName('plus-btn');
            const minusBtns = document.getElementsByClassName('minus-btn');

            // 플러스 버튼 클릭 시 수량 증가
            Array.from(plusBtns).forEach(function (plusBtn) {
                plusBtn.addEventListener('click', function(e) {
                    const quantityInput = e.target.parentNode.querySelector('.quantity');
                    let value = parseInt(quantityInput.value); // 변경 전 수량
                    value = isNaN(value) ? 0 : value;
                    let modValue = value + 1; // 수정된 수량
                    quantityInput.value = modValue;

                    // 해당 상품 목록 박스 가격 변동 //
                    const cartInfo = e.target.parentNode.parentNode.parentNode; // 버튼의 부모의 부모의 부모태그
                    const prodPrice = cartInfo.querySelector('[name="prodPrice"]'); // 원래 가격 x 수량
                    const prodDiscount = cartInfo.querySelector('[name="prodDiscount"]'); // 상품 할인율
                    const prodDisPrice = cartInfo.querySelector('[name="prodDisPrice"]'); // 할인된 가격 x 수량
                    const prodPoint = cartInfo.querySelector('[name="prodPoint"]'); // 할인된 가격 x 수량 x 10%

                    let oneProdPrice = parseInt(prodPrice.innerText) / value; // 상품 1개 가격
                    let modProdPrice = oneProdPrice * modValue; // 원래 가격 x 수정된 수량
                    let modProdDisPrice = (oneProdPrice - (oneProdPrice * parseInt(prodDiscount.innerText) / 100)) * modValue; // 할인된 가격 x 수정된 수량
                    let modProdPoint = modProdDisPrice / 10; // 할인된 가격 x 수정된 수량 x 10%

                    prodPrice.innerText = modProdPrice;
                    prodDisPrice.innerText = modProdDisPrice;
                    prodPoint.innerText = modProdPoint;
                    // 전체 주문예상금액 가격 변동 //
                    orderPriceSub();
                });
            })


            // 마이너스 버튼 클릭 시 수량 감소
            Array.from(minusBtns).forEach(function (minusBtn) {
                minusBtn.addEventListener('click', function(e) {
                    const quantityInput = e.target.parentNode.querySelector('.quantity');
                    let value = parseInt(quantityInput.value);
                    value = isNaN(value) ? 0 : value;
                    let modValue = value - 1;
                    if (value > 1) {
                        quantityInput.value = modValue;
                    }

                    // 해당 상품 목록 박스 가격 변동 //
                    const cartInfo = e.target.parentNode.parentNode.parentNode; // 버튼의 부모의 부모의 부모태그
                    const prodPrice = cartInfo.querySelector('[name="prodPrice"]'); // 원래 가격 x 수량
                    const prodDiscount = cartInfo.querySelector('[name="prodDiscount"]'); // 상품 할인율
                    const prodDisPrice = cartInfo.querySelector('[name="prodDisPrice"]'); // 할인된 가격 x 수량
                    const prodPoint = cartInfo.querySelector('[name="prodPoint"]'); // 할인된 가격 x 수량 x 10%

                    let oneProdPrice = parseInt(prodPrice.innerText) / value; // 상품 1개 가격
                    let modProdPrice = oneProdPrice * modValue; // 원래 가격 x 수정된 수량
                    let modProdDisPrice = (oneProdPrice - (oneProdPrice * parseInt(prodDiscount.innerText) / 100)) * modValue; // 할인된 가격 x 수정된 수량
                    let modProdPoint = modProdDisPrice / 10; // 할인된 가격 x 수정된 수량 x 10%

                    prodPrice.innerText = modProdPrice;
                    prodDisPrice.innerText = modProdDisPrice;
                    prodPoint.innerText = modProdPoint;
                    // 전체 주문예상금액 가격 변동 //
                    orderPriceSub();
                });
            })

        //// 주문하기 버튼 클릭시 DB에서 수량조절 후 order로 전달 ////
            const btnOrder = document.getElementsByClassName('btnOrder')[0];
            btnOrder.onclick = function () {
                const cart_prodNo = document.getElementsByName('cart_prodNo');
                const prodCount = document.getElementsByName('prodCount');
                const uid = document.getElementById('uid').value;

                const modCart_prodNo = []; // cart_product 번호
                const modCount = []; // 수량

                for (let i = 0; i < cart_prodNo.length; i++) {
                    const currentProdNo = cart_prodNo[i].value; // 현재 상품 번호
                    const currentCount = prodCount[i].value; // 현재 수량
                    modCart_prodNo.push(currentProdNo);
                    modCount.push(currentCount)
                }
                console.log(modCart_prodNo);
                console.log(modCount);

                const jsonData = {
                    "cart_prodNo" : modCart_prodNo,
                    "count" : modCount
                };
                const jsonData2 = {
                    "uid" : uid,
                    "cart_prodNo" : modCart_prodNo
                };

                fetch("/farmstory/market/modCount", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(jsonData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('수량 변경에 실패했습니다.');
                        }
                        return response.json()
                    })
                    .then(data => {
                        console.log(data);
                        // 성공일 경우 uid, modCart_prodNo 들고 /market/order로 넘어감
                        // window.location.href = `/market/order?uid=${uid}&cart_prodNo=${modCart_prodNo}`;
                        if (data.data === "수량 변경 성공"){
                            fetch("/farmstory/market/order", {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(jsonData2)
                            })
                                .then(Response => {
                                    console.log(Response);
                                    if(Response.ok) {
                                        window.location.href = '/farmstory/market/order';
                                    }
                                })
                                .catch(err => console.log(err))
                        }
                    })
                    .catch(err => console.log(err))
            }

            const prodCheckBox = document.querySelectorAll('.prodCheckBox');
            const btnDeleteProds = document.getElementById('btnDeleteProds');

            btnDeleteProds.onclick = function (e) {
                // 삭제할 상품의 번호를 저장하는 배열
                let cart_prodNo = [];
                let deleteDiv = [];
                // forEach로 순회하며 checked된 상품의 번호 찾기
                prodCheckBox.forEach(check => {
                    if (check.checked){
                        const checkBox = check;
                        const div = checkBox.parentNode;
                        deleteDiv.push(div);
                        cart_prodNo.push(div.querySelector('[name="cart_prodNo"]').value);
                    }
                })
                alert(cart_prodNo);
                // 삭제
                let result = false;
                if (cart_prodNo.length != 0){
                    result = confirm("선택하신 상품을 장바구니에서 삭제하시겠습니까?");
                }else {
                    return;
                }
                if (result){
                    const jsonData = {
                        "cart_prodNo" : cart_prodNo
                    }
                    fetch("/farmstory/market/deleteCart", {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(jsonData)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('삭제에 실패했습니다.');
                            }
                            return response.json()
                        })
                        .then(data => {
                            console.log("g3");

                            if (data.data === "삭제 성공"){
                                for (let i = 0; i < cart_prodNo.length; i++) {
                                    console.log(cart_prodNo[i]);
                                    deleteDiv[i].remove();
                                }
                                // 다음 삭제를 위해 배열 비우기
                                cart_prodNo.length = 0;
                                deleteDiv.length = 0;
                                // 전체 주문예상금액 가격 변동 //
                                orderPriceSub();
                            }
                        })
                        .catch(err => console.log(err))
                }else {
                    cart_prodNo.length = 0;
                    deleteDiv.length = 0;
                    alert("취소되었습니다.");
                }
            }

        //// 개별 상품 삭제 ////
            const btnDeleteProd = document.getElementsByClassName('btnDeleteProd');
            Array.from(btnDeleteProd).forEach(function (delProd) {
                delProd.addEventListener('click', function(e) {
                    const cartInfo = e.target.parentNode.parentNode.parentNode; // 버튼의 부모의 부모의 부모태그
                    let cart_prodNo = [];

                    cart_prodNo.push(cartInfo.querySelector('[name="cart_prodNo"]').value);
                    let result = confirm("해당 상품을 장바구니에서 삭제하시겠습니까?");

                    if (result){
                        const jsonData = {
                            "cart_prodNo" : cart_prodNo
                        }
                        fetch("/farmstory/market/deleteCart", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(jsonData)
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('삭제에 실패했습니다.');
                                }
                                return response.json()
                            })
                            .then(data => {
                                console.log("g3");

                                if (data.data === "삭제 성공"){
                                    cartInfo.remove();
                                    cart_prodNo.length = 0;
                                    // 전체 주문예상금액 가격 변동 //
                                    orderPriceSub();
                                }
                            })
                            .catch(err => console.log(err))
                    }else {
                        cart_prodNo.length = 0;
                        alert("취소되었습니다.");
                    }


                })
            })

        } //window.onload 끝//

    //// 각 장바구니 품목 가격 합산하는 함수 ////
        function orderPriceSub() {
            const totalCount = document.getElementById('totalCount');
            const totalPrice = document.getElementById('totalPrice');
            const totalDiscount = document.getElementById('totalDiscount');
            const totalDelCost = document.getElementById('totalDelCost');
            const totalPoint = document.getElementById('totalPoint');
            const totalOrder = document.getElementById('totalOrder');

            const prodCount = document.getElementsByName('prodCount');
            const prodPrice = document.getElementsByName('prodPrice'); // 할인 전 가격
            const prodPoint = document.getElementsByName('prodPoint');
            const prodDisPrice = document.getElementsByName('prodDisPrice');

            let totalProdCount = 0;
            let totalProdPrice = 0;
            let totalProdDisPrice = 0;
            let totalProdDelCost = 0;
            let totalProdPoint = 0;
            let totalProdTotal = 0;

            // 각 포인트, 가격, 할인, 합계값 더하는 for문
            for (let i = 0; i < prodPoint.length; i++) {
                totalProdCount += 1;
                totalProdPrice += parseInt(prodPrice[i].innerText);
                totalProdDisPrice += (parseInt(prodPrice[i].innerText) - parseInt(prodDisPrice[i].innerText));
                totalProdTotal += parseInt(prodDisPrice[i].innerText);
                totalProdPoint += (parseInt(prodDisPrice[i].innerText) / 10);
                if (totalProdTotal >= 30000) {
                    totalProdDelCost = 0;
                }else{
                    totalProdDelCost = 5000;
                }
            }
            // 태그에 값 출력하기
            totalPrice.innerText = totalProdPrice.toString();
            totalDiscount.innerText = totalProdDisPrice.toString();
            totalDelCost.innerText = totalProdDelCost.toString();
            totalOrder.innerText = (totalProdTotal+parseInt(totalDelCost.innerText)).toString();
            totalPoint.innerText = totalProdPoint.toString();
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <div class="userBox">
                <a href="">로그인</a>
                <a href="">회원가입</a>
                <a href="">고객센터</a>
            </div>

            <div class="logoBox">
                <a href=""><img th:src="@{/newimage/farm_header_logo.png}" alt="logoImg"></a>

                <form action="">
                    <label for="indexSearch">
                        <input type="text" id="indexSearch" placeholder="검색어를 입력하세요">
                        <button><img th:src="@{/newimage/farm_header_search.svg}" alt="button"></button>
                    </label>
                </form>

                <div class="btnUserBox">
                    <a href="" class="btnUser">
                        <img class="btnUserImg1" th:src="@{/newimage/farm_header_cart.png}" alt="cart">
                        <h5>장바구니</h5>
                    </a>
                    <a href="" class="btnUser">
                        <img class="btnUserImg2" th:src="@{/newimage/farm_header_user.png}" alt="">
                        <h5>마이페이지</h5>
                    </a>
                    <a href="" class="btnUser">
                        <img class="btnUserImg3" th:src="@{/newimage/farm_header_order.png}" alt="">
                        <h5>배송조회</h5>
                    </a>
                </div>
            </div>

            <div class="navBox">
                <ul>
                    <li><a href="">팜스토리소개</a></li>
                    <li><a href="">장보기</a></li>
                    <li><a href="">농작물이야기</a></li>
                    <li><a href="">이벤트</a></li>
                    <li><a href="">커뮤니티</a></li>
                </ul>
            </div>

            <div class="bgBox">
                <img th:src="@{/newimage/farm_top_text_market.png}" alt="top_bg">
            </div>

        </header>

        <main class="articleMain">
            <div class="sideBox">
                <img src="../image/farm_market_logo.png" alt="">
                <ul>
                    <li><a class="" href="">장보기</a></li>
                    <li><a class="tabOn" href="">장바구니</a></li>
                    <li><a class="" href="">배송조회</a></li>
                </ul>
            </div>

            <div class="contentBox">
                <div class="articleHeader">
                    <h2>장바구니</h2>
                    <h5>HOME > 장보기 > <span>장바구니</span></h5>
                </div>

                <div class="articleBox">

                    <div class="cartHeader">
                        <input type="checkbox" class="totalCheckBox">
                        <h4>전체선택</h4>
                        <a id="btnDeleteProds" style="cursor: pointer">선택삭제</a>
                    </div>

                    <div class="prodInfoBox">

                        <div class="cartBox">

                            <!--장바구니 품목 시작-->
                            <div class="cartItem" th:each="product : ${productDTO}">
                                <input type="checkbox" class="prodCheckBox">
                                <input type="hidden" name="cart_prodNo" th:value="${product.cart_prodNo}">
                                <input type="hidden" id="uid" value="skdlawo5985@gmail.com">
                                <!--나중에 변경해야함 ${#authentication.principal.user.uid} -->
                                <a class="cartImg" href="">
                                    <img th:src="@{'/imagePath/'+${product.thumb}}" class="thumb" alt="">
                                </a>

                                <div class="cartInfo">
                                    <p>
                                        <a href="">
                                            <b class="prodName">[[${product.prodname}]]</b>
                                            <b th:if="${product.amount} >= 1000" th:text="(${product.amount}/1000)+'kg'"></b>
                                            <b th:if="${product.amount} < 1000" th:text="${product.amount}+'g'"></b>
                                        </a>
                                        <a class="btnDeleteProd" style="cursor: pointer">삭제</a>
                                    </p>
                                    <p>
                                        <span><b class="prodDiscount" th:text="${product.discount}" th:name="prodDiscount"></b>%</span>
                                        <span><s class="prodPrice" th:text="${product.price}*${product.count}" th:name="prodPrice"></s>원</span>
                                    </p>
                                    <p>
                                        <span>
                                            <b class="prodCutPrice" th:text="(${product.price}-(${product.price}*${product.discount}/100))*${product.count}" th:name="prodDisPrice">
                                            </b>원
                                        </span>
                                    </p>

                                    <div class="cartInfoBot">
                                        <div>
                                            <p>
                                                <span>
                                                    <b class="prodPoint" th:text="((${product.price}-(${product.price}*${product.discount}/100))*10/100)*${product.count}" th:name="prodPoint">
                                                    </b> 팜포인트 적립
                                                </span>
                                            </p>
                                            <p><span><b class="prodDelDate">04-03</b>도착 예정</span></p>
                                        </div>

                                        <div class="quantity-input">
                                            <button class="minus-btn" type="button">-</button>
                                            <input type="text" class="quantity prodQnty" th:name="prodCount" th:value="${product.count}">
                                            <button class="plus-btn" type="button">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--장바구니 품목 끝-->
                        </div>

                        <div class="cartTotal">
                            <p>주문예상금액</p>
                            <p>총 상품 가격<span><b id="totalPrice"></b>원</span></p>
                            <p>총 할인<span>- <b id="totalDiscount"></b>원</span></p>
                            <p>배송비<span>+ <b id="totalDelCost"></b>원</span></p>
                            <p>결제 금액<span><b id="totalOrder"></b>원</span></p>
                            <p>적립 포인트<span><b id="totalPoint"></b> P</span></p>
                            <button class="btnOrder">주문하기</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="footerImgBox">
                <img src="../image/farm_footer_logo.png" alt="">
                <img src="../image/farm_footer_wood.png" alt="">
            </div>
            <p>
                (주)팜스토리 / 사업자등록번호 123-45-67890 / 통신판매업신고 제 2013-팜스토리구-123호 / 벤처기업확인 서울지방중소기업청 제 012345678-9-01234호
                <br>
                등록번호 팜스토리01234 (2013.04.01) / 발행인 : 홍길동
                <br>
                대표 : 홍길동 / 이메일 : email@mail.mail / 전화 : 01) 234-5678 / 경기도 성남시 잘한다구 신난다동 345
                <br>
                <em>Copyright(C)홍길동 All rights reserved. 0.0.4-SNAPSHOT</em>
            </p>
        </footer>
    </div>
</body>
</html>